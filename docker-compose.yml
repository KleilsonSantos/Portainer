services:
  portainer:
    image: portainer/portainer-ce:latest # ğŸ“¦ Portainer CE (Community Edition) image
    container_name: portainer # ğŸ·ï¸ Container name
    restart: always # ğŸ” Automatically restarts if it stops
    ports:
      - '9000:9000' # ğŸŒ Web access
      - '8000:8000' # ğŸ› ï¸ Agent access
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock # ğŸ§© Direct communication with Docker
      - portainer-data:/data # ğŸ’¾ Volume for data persistence
    environment:
      - TZ=America/Sao_Paulo # ğŸ•’ Set the timezone
    security_opt:
      - no-new-privileges:true # ğŸ” Prevent privilege escalation
    networks:
      - portainer-network # ğŸŒ Connects to the named network

  # ğŸ› ï¸ PostgreSQL for SonarQube
  postgres:
    image: postgres:14 # ğŸ“¦ PostgreSQL 14 image
    container_name: postgres-portainer # ğŸ·ï¸ Container name
    ports:
      - '5432:5432' # ğŸŒ Web access
    restart: always # ğŸ” Automatically restarts if it stops
    environment:
      POSTGRES_DB: sonarqube # ğŸ—„ï¸ Database name
      POSTGRES_USER: sonarqube # ğŸ‘¤ Database username
      POSTGRES_PASSWORD: sonarqube # ğŸ”‘ Database password
      POSTGRES_INITDB_ARGS: '--encoding=UTF8 --locale=en_US.UTF-8' # ğŸŒ Database encoding and locale
      POSTGRES_HOST_AUTH_METHOD: trust # ğŸ” Authentication method
    volumes:
      - postgres-portainer-data:/var/lib/postgresql/data # ğŸ’¾ Volume for data persistence
    networks:
      - portainer-network # ğŸŒ Connects to the named network

  # ğŸ“Š SonarQube service
  sonarqube:
    image: sonarqube:lts # ğŸ“¦ SonarQube LTS image
    container_name: sonarqube-portainer # ğŸ·ï¸ Container name
    restart: always # ğŸ” Automatically restarts if it stops
    depends_on:
      - postgres # ğŸ˜ Depends on PostgreSQL
    ports:
      - '9090:9090' # ğŸŒ Web access
    environment:
      - SONAR_JDBC_URL=jdbc:postgresql://postgres-portainer:5432/sonarqube # ğŸ˜ PostgreSQL connection URL
      - SONAR_JDBC_USERNAME=sonarqube # ğŸ‘¤ Database username
      - SONAR_JDBC_PASSWORD=sonarqube # ğŸ”‘ Database password
      - SONARQUBE_JVM_OPTIONS='-Xmx4G -Xms4G' # ğŸ“Š JVM memory configuration
    volumes:
      - sonarqube-portainer-data:/opt/sonarqube/data # ğŸ’¾ Volume for data persistence
      - sonarqube-portainer-logs:/opt/sonarqube/logs # ğŸ“œ Volume for logs
      - sonarqube-portainer-extensions:/opt/sonarqube/extensions # ğŸ“¦ Volume for extensions
    networks:
      - portainer-network # ğŸŒ Connects to the named network

volumes:
  portainer-data: # ğŸ’½ Named volume
    name: portainer-data # ğŸ·ï¸ Visible Docker volume name

  postgres-portainer-data: # ğŸ’½ Named volume
    name: postgres-portainer-data # ğŸ·ï¸ Visible Docker volume name

  sonarqube-portainer-data: # ğŸ’½ Named volume
    name: sonarqube-portainer-data # ğŸ·ï¸ Visible Docker volume name

  sonarqube-portainer-extensions: # ğŸ’½ Named volume
    name: sonarqube-portainer-extensions # ğŸ·ï¸ Visible Docker volume name

  sonarqube-portainer-logs: # ğŸ’½ Named volume
    name: sonarqube-portainer-logs # ğŸ·ï¸ Visible Docker volume name

networks:
  portainer-network: # ğŸŒ Custom network
    name: portainer-network # ğŸ·ï¸ Visible Docker network name
    driver: bridge # ğŸŒ‰ Bridge network driver
